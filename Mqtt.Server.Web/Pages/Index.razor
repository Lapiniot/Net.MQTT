@page "/"
@using System.Numerics
@inject System.Net.Mqtt.Server.IMqttServer Server
@implements IDisposable

<PageTitle>MQTT Server Statistics</PageTitle>

@if (@statistics is null)
{
    <div>Server doesn't provide statistics data.</div>
    return;
}

<div class="grid-auto">
    <div class="border p-2 rounded-2 bg-light text-truncate">
        <h6>Bytes received</h6>
        @FormatSize(@statistics.GetBytesReceived())
    </div>
    <div class="border p-2 rounded-2 bg-light text-truncate">
        <h6>Bytes sent</h6>
        @FormatSize(@statistics.GetBytesSent())
    </div>
    <div class="border p-2 rounded-2 bg-light text-truncate">
        <h6>Packets received</h6>
        @FormatCount(@statistics.GetPacketsReceived())
    </div>
    <div class="border p-2 rounded-2 bg-light text-truncate">
        <h6>Packets sent</h6>
        @FormatCount(@statistics.GetPacketsSent())
    </div>
</div>

@code {
    private static string[] suffixes = { "Bytes", "KB", "MB", "TB" };
    private IProvideDataStatistics? statistics;
    private PeriodicTimer periodicTimer = new PeriodicTimer(TimeSpan.FromSeconds(2));

    async Task StartRefreshTaskAsync()
    {
        while (await periodicTimer.WaitForNextTickAsync())
        {
            StateHasChanged();
        }
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        statistics = Server.GetFeature<IProvideDataStatistics>();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        if (firstRender)
        {
            _ = StartRefreshTaskAsync();
        }
    }

    public void Dispose()
    {
        periodicTimer.Dispose();
    }

    private string FormatCount(long count)
    {
        return count.ToString("N0");
    }

    private string FormatSize(long bytes)
    {
        var p = Math.Min((int)(BitOperations.Log2((ulong)bytes) / 10), 3);
        var n = bytes / Math.Pow(1024, p);
        return $"{n:N2} {suffixes[p]}";
    }
}